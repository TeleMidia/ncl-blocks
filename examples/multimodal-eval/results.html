<!DOCTYPE html>
<html>

<head>
  <title>multimodal evaluation results</title>
  <meta charset="utf-8">
  <!-- nclblocks-->
  <script src="../../src/blockly_compressed.js"></script>
  <script src="../../src/blocks_compressed.js"></script>
  <script src="../../src/pt-br.js"></script>
  <script src="../../src/nclblocks.js"></script>
  <!-- syntaxhighlighter_v3.js -->
  <link type="text/css" rel="stylesheet" href="../../src/syntaxhighlighter_v3/shCore.css">
  <link type="text/css" rel="stylesheet" href="../../src/syntaxhighlighter_v3/shThemeDefault.css">
  <script type="text/javascript" src="../../src/syntaxhighlighter_v3/shCore.js"></script>
  <script type="text/javascript" src="../../src/syntaxhighlighter_v3/shBrushXml.js"></script>

  <!-- bootstrap-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" crossorigin="anonymous">
  <!-- jquery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js">
  </script>

  <!-- survey.js -->
  <script src="https://surveyjs.azureedge.net/0.12.7/survey.jquery.min.js"></script>
</head>

<body>
  <div class="center-block text-center">
    <br> resultIndex=
    <select id="resultIndex" type="text" value="-"><option value="-">-</option></select> blockTask=
    <select id="blockTask" type="text" value="blocksEditTask1">
      <option value="blocksEditTask1">blocksEditTask1</option>
      <option value="blocksEditTask2">blocksEditTask2</option>
      </select>
    <br><br>
    <button id="showChanges" class="btn">showChanges</button>
    <br>
  </div>
  <table style="width:100%;height:100%;">
    <tr>
      <th class="text-center">blocks</th>
      <th class="text-center">xml</th>
    </tr>
    <tr>
      <td style="width:70%;height:100%;">
        <div id="divToInject"></div>
      </td>
      <td style="width:30%;height:100%;">
        <textarea id="xmlcode" style="width:100%;height:100%;" disabled></textarea>
      </td>
    </tr>
  </table>
  <script>
    // ----------------------------------------
    // blockly
    // ----------------------------------------
    var _workspace = NclBlocks.injectInDiv('../../src/', 'divToInject', '800px', '', true)

    // ----------------------------------------
    // request
    // ----------------------------------------
    // wget dxsurvey.com/api/MySurveys/getSurveyResults/59bd2657-93ac-492c-8dd5-134a10ebd69a?accessKey=d72526e70b814a3d8f918b60b94dafe4 -O result.json
    var _resultsData

    $.get('http://dxsurvey.com/api/MySurveys/getSurveyResults/59bd2657-93ac-492c-8dd5-134a10ebd69a?accessKey=d72526e70b814a3d8f918b60b94dafe4', function (data) {
      _resultsData = data.Data
      for (var i in _resultsData) {
        $('#resultIndex').append($('<option>').attr('value', i).html(i))
      }
    })

    // ----------------------------------------
    // choose result
    // ----------------------------------------

    var testEmptyXML = function () {
      if ($('#xmlcode').val() === '') {
        $('#xmlcode').val('empty XML')
        return true
      } else {
        return false
      }
    }

    var showBlocksXML = function () {
      _workspace.clear()
      $('#xmlcode').val('')

      var selected = $('#resultIndex option:selected').val()
      if (selected === '-') return
      var selectIndex = parseInt(selected)
      var savedWorkspaceXml
      if ($('#blockTask option:selected').val() === 'blocksEditTask1') {
        savedWorkspaceXml = _resultsData[selectIndex].blocksEditTask1Result
      } else if ($('#blockTask option:selected').val() === 'blocksEditTask2') {
        savedWorkspaceXml = _resultsData[selectIndex].blocksEditTask2Result
      }
      $('#xmlcode').val(savedWorkspaceXml)
      Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(savedWorkspaceXml), _workspace)
      testEmptyXML()
    }

    $('#resultIndex').change(function () {
      if (_resultsData == null) return
      $('#blockTask').val('blocksEditTask1')
      showBlocksXML()
    })

    $('#blockTask').change(function () {
      showBlocksXML()
    })

    // ----------------------------------------
    // show changes button
    // ----------------------------------------
    var _runEventFrequency = 200
    var _runEventIntervalIndex = 0
    var runEventInterval = function (index) {
      var result
      if ($('#blockTask option:selected').val() === 'blocksEditTask1') {
        result = JSON.parse(_resultsData[index].blocksEditTask1Changes)
      } else if ($('#blockTask option:selected').val() === 'blocksEditTask2') {
        result = JSON.parse(_resultsData[index].blocksEditTask2Changes)
      }
      if (_runEventIntervalIndex >= result.changes.length) {
        clearInterval(runEventInterval)
        return
      }
      var json = result.changes[_runEventIntervalIndex]
      var event = Blockly.Events.fromJson(json, _workspace)
      event.run(true)
      _runEventIntervalIndex++
    }

    $('#showChanges').click(function () {
      if (_resultsData == null) return
      var selected = $('#resultIndex option:selected').val()
      if (selected === '-') return
      _workspace.clear()
      var index = parseInt(selected)
      _runEventIntervalIndex = 0
      clearInterval(runEventInterval)
      setInterval(runEventInterval, _runEventFrequency, index)
    })
  </script>
</body>

</html>