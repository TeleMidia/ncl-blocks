<!DOCTYPE html>
<html>

<head>
  <title>thesis questionario view block result</title>
  <meta charset="utf-8">
  <!-- nclblocks-->
  <script src="nclblocks/blockly_compressed.js"></script>
  <script src="nclblocks/blocks_compressed.js"></script>
  <script src="nclblocks/pt-br.js"></script>
  <script src="nclblocks/nclblocks.js"></script>
  <!-- bootstrap-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" crossorigin="anonymous">
  <!-- jquery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js">

  </script>
  <!-- syntaxhighlighter_v3.js -->
  <link type="text/css" rel="stylesheet" href="syntaxhighlighter_v3/shCore.css">
  <link type="text/css" rel="stylesheet" href="syntaxhighlighter_v3/shThemeDefault.css">
  <script type="text/javascript" src="syntaxhighlighter_v3/shCore.js"></script>
  <script type="text/javascript" src="syntaxhighlighter_v3/shBrushXml.js"></script>
  <!-- survey.js -->
  <script src="https://surveyjs.azureedge.net/0.12.7/survey.jquery.min.js"></script>
</head>

<body>
  <div id="content" class="center-block text-center" style="width: 55%">
    resultId=<select id="result_number" type="text" value="0">
    </select>
    <br><br><button id="changes">show changes</button><br><br>
  </div>
  <script>
    // ---------------------------------------- 
    // blockly
    // ---------------------------------------- 
    Blockly.pathToBlockly = 'nclblocks/'
    var _workspace = NclBlocks.injectInDiv("content", "", "", false, true, "800px");

    // ---------------------------------------- 
    // request
    // ---------------------------------------- 
    // wget dxsurvey.com/api/MySurveys/getSurveyResults/59bd2657-93ac-492c-8dd5-134a10ebd69a?accessKey=d72526e70b814a3d8f918b60b94dafe4 -O result.json
    var _results_data
    
    $.get("http://dxsurvey.com/api/MySurveys/getSurveyResults/59bd2657-93ac-492c-8dd5-134a10ebd69a?accessKey=d72526e70b814a3d8f918b60b94dafe4", function (data) {
      _results_data = data.Data;
      // console.log(_results_data);
      for (var i = 0; i < _results_data.length; i++) {
        $("<option />").attr("value", i).html(i).appendTo("#result_number");
      }
      $('#result_number').val('0').change();
    });
    $("#result_number").change(function () {
      var select_value = parseInt($(this).val());
      // console.log(_results_data);
      var saved_workspace = _results_data[select_value].concepts_task1_result;
      _workspace.clear();
      Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(saved_workspace), _workspace);
      var blocks = _workspace.getAllBlocks();
      for (var i = 0; i < blocks.length; i++) {
        blocks[i].setEditable(false);
        blocks[i].setMovable(false);
      }
    });

    // ---------------------------------------- 
    // show changes button
    // ---------------------------------------- 
    var _run_event_frequency = 100;
    var _run_event_interval_index = 0;
    var _run_event_interval = function (index) {
      var result = JSON.parse(_results_data[index].concepts_task1_changes);
      if (_run_event_interval_index >= result.changes.length) {
        clearInterval(_run_event_interval);
        return;
      }
      var json = result.changes[_run_event_interval_index];
      // console.log(json);
      // console.log(_run_event_interval_index);
      var event = Blockly.Events.fromJson(json, _workspace);
      event.run(true);
      var blocks = _workspace.getAllBlocks();
      for (var i = 0; i < blocks.length; i++) {
        blocks[i].setEditable(false);
        blocks[i].setMovable(false);
      }
      _run_event_interval_index++;
    }

    $("#changes").click(function () {
      if (_results_data == null) return;
      var index = parseInt(($("#result_number option:selected").val()));
      _workspace.clear();
      _run_event_interval_index = 0;
      clearInterval(_run_event_interval);
      setInterval(_run_event_interval, _run_event_frequency, index);
    });
  </script>
</body>

</html>