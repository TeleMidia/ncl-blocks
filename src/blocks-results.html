<!DOCTYPE html>
<html>

<head>
  <title>thesis questionario view block result</title>
  <meta charset="utf-8">
  <!-- nclblocks-->
  <script src="nclblocks/blockly_compressed.js"></script>
  <script src="nclblocks/blocks_compressed.js"></script>
  <script src="nclblocks/pt-br.js"></script>
  <script src="nclblocks/nclblocks.js"></script>
  <!-- bootstrap-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" crossorigin="anonymous">
  <!-- jquery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js">

  </script>
  <!-- syntaxhighlighter_v3.js -->
  <link type="text/css" rel="stylesheet" href="syntaxhighlighter_v3/shCore.css">
  <link type="text/css" rel="stylesheet" href="syntaxhighlighter_v3/shThemeDefault.css">
  <script type="text/javascript" src="syntaxhighlighter_v3/shCore.js"></script>
  <script type="text/javascript" src="syntaxhighlighter_v3/shBrushXml.js"></script>
  <!-- survey.js -->
  <script src="https://surveyjs.azureedge.net/0.12.7/survey.jquery.min.js"></script>
</head>

<body>
  <div class="center-block text-center">
    <br> resultId=<select id="result_number" type="text" value="-"><option value="-">-</option></select>
    <br><br>
    <button id="changes" class="btn">show changes</button>
    <br>
  </div>
  <table style="width:100%;height:100%;">
    <tr>
      <th class="text-center">blocks</th>
      <th class="text-center">xml</th>
    </tr>
    <tr>
      <td style="width:70%;height:100%;">
        <div id="divToInject"></div>
      </td>
      <td style="width:30%;height:100%;">
        <textarea id="xmlcode" style="width:100%;height:100%;" disabled></textarea>
      </td>
    </tr>
  </table>
  <script>
    // ---------------------------------------- 
    // blockly
    // ---------------------------------------- 
    var _workspace = NclBlocks.injectInDiv('nclblocks/', 'divToInject', "800px", "", true);

    // ---------------------------------------- 
    // request
    // ---------------------------------------- 
    // wget dxsurvey.com/api/MySurveys/getSurveyResults/59bd2657-93ac-492c-8dd5-134a10ebd69a?accessKey=d72526e70b814a3d8f918b60b94dafe4 -O result.json
    var _results_data

    $.get("http://dxsurvey.com/api/MySurveys/getSurveyResults/59bd2657-93ac-492c-8dd5-134a10ebd69a?accessKey=d72526e70b814a3d8f918b60b94dafe4", function (data) {
      _results_data = data.Data;
      for (var i = 0; i < _results_data.length; i++) {
        $("#result_number").append($('<option>').attr("value", i).html(i));
      }
    });
    $("#result_number").change(function () {
      if (_results_data == null) return;
      var selected = $("#result_number option:selected").val();
      if (selected == '-') return;
      var select_index = parseInt(selected);
      _workspace.clear();
      var saved_workspace_xml = _results_data[select_index].concepts_task1_result;
      // console.log(saved_workspace_xml);
      $("#xmlcode").text(saved_workspace_xml);
      Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(saved_workspace_xml), _workspace);
    });

    // ---------------------------------------- 
    // show changes button
    // ---------------------------------------- 
    var _run_event_frequency = 200;
    var _run_event_interval_index = 0;
    var runEventInterval = function (index) {
      var result = JSON.parse(_results_data[index].concepts_task1_changes);
      if (_run_event_interval_index >= result.changes.length) {
        clearInterval(runEventInterval);
        return;
      }
      var json = result.changes[_run_event_interval_index];
      // console.log(json);
      var event = Blockly.Events.fromJson(json, _workspace);
      event.run(true);
      _run_event_interval_index++;
    }

    $("#changes").click(function () {
      if (_results_data == null) return;
      var selected = $("#result_number option:selected").val();
      if (selected == '-') return;
      _workspace.clear();
      var index = parseInt(selected);
      _workspace.clear();
      _run_event_interval_index = 0;
      clearInterval(runEventInterval);
      setInterval(runEventInterval, _run_event_frequency, index);
    });
  </script>
</body>

</html>